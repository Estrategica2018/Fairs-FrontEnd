<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/super-admin/fair"></ion-back-button>
    </ion-buttons>
    <ion-buttons slot="end" *ngIf="action==='update'">
      <ion-button color="danger" (click)="onDeleteAgenda()">
        <ion-icon slot="start" name="trash-outline"></ion-icon>
        Borrar
      </ion-button>
    </ion-buttons>
    <ion-title>Administrar Agenda</ion-title>
  </ion-toolbar>
</ion-header>
    
<ion-content fullscreen="true">

    <ion-list lines="" *ngIf="agenda" class="padding-container">
      <form [formGroup]="agendaForm" (ngSubmit)="onSave()"  [ngClass]="{'mt-3': !errors && !success }">

      <ion-item class="padding-container agenda-logo mt-4" *ngIf="agenda && agenda.category" button="true">
        <img [src]="agenda?.category?.resources?.image" *ngIf="agenda.category.resources && agenda.category.resources.image">
      </ion-item>
      
      <ion-grid>
        <ion-row>
          <ion-col  size="12" class="fs-1">
            <ion-label position="stacked">
                Categoría <span class="required"> (*) </span>
            </ion-label>
            <ion-select interface="popover" class="fs-0 mt-3 form-control" formControlName="category"
            (change)="changeCategory()"
            (ionChange)="changeCategory()"
            [ngClass]="{ 'is-invalid': submitted && f.category.errors }"
            >
              <ion-select-option *ngFor="let category of categories" value="{{category.id}}">{{category.name}}
              </ion-select-option>
            </ion-select>
            <div *ngIf="submitted && f.category.errors" class="invalid-feedback">
            <div *ngIf="f.category.errors.required">Campo requerido</div>
            </div>
          </ion-col>
          


          <ion-col size="12" class="fs-1">
            <ion-label position="stacked">
                Título <span class="required"> (*) </span>
            </ion-label>
            <input type="text" formControlName="title" maxlength="191" class="fs-0 mt-3 form-control" [ngClass]="{ 'is-invalid': submitted && f.title.errors }" />
            <div *ngIf="submitted && f.title.errors" class="invalid-feedback">
            <div *ngIf="f.title.errors.required">Campo requerido</div>
            </div>
          </ion-col>
          <ion-col size="12" class="fs-1">
            <ion-label position="stacked">
                Descripción <span class="required"> (*) </span>
            </ion-label>
            <input type="text" formControlName="description"  class="fs-0 mt-3 form-control" [ngClass]="{ 'is-invalid': submitted && f.description.errors }" />
            <div *ngIf="submitted && f.description.errors" class="invalid-feedback">
            <div *ngIf="f.description.errors.required">Campo requerido</div>
            </div>
          </ion-col>
          <ion-col size="12" class="fs-1">
            <ion-label position="stacked">
                Fecha de inicio <span class="required"> (*) </span>
            </ion-label>
            <ion-datetime class="fs-0 mt-3 form-control" min="2019" max="2030" formControlName="date" 
            [ngClass]="{ 'is-invalid': submitted && f.date.errors }"
            (ionChange)="onChangeStartTime()" display-format="DD/MM/YYYY" picker-format="DD/MM/YYYY"></ion-datetime>
            <div *ngIf="submitted && f.date.errors" class="invalid-feedback">
            <div *ngIf="f.date.errors.required">Campo requerido</div>
            </div>
          </ion-col>
          <ion-col size="12" class="fs-1">
            <ion-label position="stacked">
                Hora de inicio <span class="required"> (*) </span>
            </ion-label>
            <ion-datetime class="fs-0 mt-3 form-control" formControlName="hour" 
            [ngClass]="{ 'is-invalid': submitted && f.hour.errors }"
            (ionChange)="onChangeStartTime()" display-format="HH:mm" picker-format="HH:mm"></ion-datetime>
            <div *ngIf="submitted && f.hour.errors" class="invalid-feedback">
            <div *ngIf="f.hour.errors.required">Campo requerido</div>
            </div>
          </ion-col>
          <ion-col  size="12" class="fs-1">
            <ion-label position="stacked">
                Zona horaria <span class="required"> (*) </span>
            </ion-label>
            <select class="fs-0 mt-3 form-control" formControlName="timezone" 
            [ngClass]="{ 'is-invalid': submitted && f.timezone.errors }"
            >
              <option *ngFor="let timezone of timezones" value="{{timezone.name}}">{{timezone.name}}
              </option>
            </select>
            <div *ngIf="submitted && f.timezone.errors" class="invalid-feedback">
            <div *ngIf="f.timezone.errors.required">Campo requerido</div>
            </div>
          </ion-col>
          
          <ion-col  size="12" class="fs-1">
            <ion-label position="stacked">
                Duración <span class="required"> (*) </span>
            </ion-label>
            <select class="fs-0 mt-3 form-control" formControlName="duration_time" 
            [ngClass]="{ 'is-invalid': submitted && f.duration_time.errors }"
            >
              <option *ngFor="let duration of durations" value="{{duration.id}}">{{duration.name}}
              </option>
            </select>
            <div *ngIf="submitted && f.duration_time.errors" class="invalid-feedback">
            <div *ngIf="f.duration_time.errors.required">Campo requerido</div>
            </div>
          </ion-col>
      
           
          <ion-col  size="12" class="fs-1">
            <ion-label position="stacked">
                Tipo de público <span class="required"> (*) </span>
            </ion-label>
            <ion-select (ionChange)="changeAudienceConfig()" interface="popover" class="fs-0 mt-3 form-control" formControlName="audience_config" 
            [ngClass]="{ 'is-invalid': submitted && f.audience_config.errors }"
            >
              <ion-select-option *ngFor="let audience of audiences" value="{{audience.id}}">{{audience.name}}
              </ion-select-option>
            </ion-select>
            <div *ngIf="submitted && f.audience_config.errors" class="invalid-feedback">
            <div *ngIf="f.audience_config.errors.required">Campo requerido</div>
            </div>
          </ion-col>
          
          <ion-col size="12" class="fs-1" *ngIf="agenda.audience_config == 4" (click)="presentActionPrice()">
            <ion-label position="stacked">
                Precio por evento <span class="required"> (*) </span>
            </ion-label>
            <input type="text" value="${{agenda.price  | currency: ' ':' ':'1.0-0'}}" readonly class="fs-0 mt-3 form-control" [ngClass]="{ 'is-invalid': submitted && !(agenda.price > 0 ) }" />
            <div class="invalid-feedback">
            <div *ngIf="submitted && !(agenda.price > 0 )">Campo requerido</div>
            </div>
          </ion-col>

        </ion-row>
        <ion-row>
           <ion-button [disabled]="initSubmitted" type="submit" (click)="onSave()" class="w-100">
            <ion-label > {{ action==='update' ? 'Guardar Cambios': 'Crear Agenda'}}  </ion-label>
              <ion-icon slot="end" name="save-outline"></ion-icon>
            </ion-button>
        </ion-row>
      </ion-grid>
    </form>  
    
      <ion-item *ngIf="action==='update' && agenda.audience_config === '2'">
       <ion-toolbar>
        <ion-buttons slot="secondary">
          <ion-button>
            <ion-icon slot="icon-only" name="person-circle"></ion-icon>
          </ion-button>
          <ion-button>
            <ion-icon slot="icon-only" name="search"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-buttons slot="primary">
          <ion-button color="secondary" (click)="presentAudience()">
            <ion-icon slot="icon-only" ios="ellipsis-horizontal" md="ellipsis-vertical"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-label slot="start">Lista de invitados</ion-label>
      </ion-toolbar>
      </ion-item>
      <ion-item *ngIf="action==='update' && agenda.audience_config === '2'">
        <div class="tag-container">
          <span class="tag" *ngFor="let audience of invited_emails">
          {{ audience.email }}
          <ion-icon name="close" (click)="deleteTag(audience)"></ion-icon>
          </span>
        </div>
      </ion-item>
       
      <ion-list-header [hidden]="!errors">
        <div class="alert alert-danger fade show alert-dismissible">
         <a href="javascript:void(0)" class="close" aria-label="close" (click)="errors=null" title="close">×</a>
           <strong></strong> {{errors}}
        </div>
      </ion-list-header>
  
      <ion-list-header [hidden]="!success">
        <div class="alert alert-success fade show alert-dismissible">
          <a href="javascript:void(0)" class="close" aria-label="close" (click)="success=null" title="close">×</a>
          <strong></strong> {{success}}
        </div>
      </ion-list-header>
      
      <ion-item lines="none" *ngIf="action==='update'">
        <ion-toolbar>
          <ion-buttons slot="primary">
            <ion-button color="primary" (click)="presentSpeakers()">
              <ion-icon slot="icon-only" ios="ellipsis-horizontal" md="ellipsis-vertical"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-label slot="start">Conferencistas</ion-label>
        </ion-toolbar>
      </ion-item>
      
      <ion-item *ngIf="action==='update'">
        <ion-grid>
          <ion-row>
            <ion-col *ngFor="let invited_speaker of invited_speakers" 
              class="d-flex pavilion-button" button="true" 
              routerLink="/super-admin/agenda/{{agenda.id}}" routerLinkActive="active" routerDirection="root" detail="false">
                <ion-avatar class="mr-3">
                  <img [src]="invited_speaker.speaker?.profile_picture">
                </ion-avatar>
                <ion-label>
                  <h2>{{invited_speaker.speaker.user.name + ' ' + invited_speaker.speaker.user.last_name}}</h2>
                  <h3>{{speakers.description}}</h3>
                  <p>{{speakers.stands?.length }} locales asociados</p>
                </ion-label>
            </ion-col>
          </ion-row>
        </ion-grid>
     </ion-item>

    </ion-list>
</ion-content>
